<!DOCTYPE html>
<html>

<head>
	<title>Exert - Live Tracking</title>

	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

	<style type="text/css">
		html { height: 100% }
		body { height: 100%; margin: 0; padding: 0 }
		#map-canvas { height: 100% }
	</style>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhsgYoAKyYFhf3JABWflVMNBDi5tPXvZo&sensor=false"></script>

	<script type="text/javascript">
		var routeCoordinates
		var contentString
		var routePath
		var map
		var marker = null
		var infoWindow = null
		var lastLat = ${centerLat}
		var lastLon = ${centerLon}

		function initialize()
		{
			var mapOptions =
			{
				center: new google.maps.LatLng(${centerLat}, ${centerLon}),
				zoom: 12
			};
			map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

			routeCoordinates =
			[
${route}
			];

			routePath = new google.maps.Polyline
			({
				path: routeCoordinates,
				geodesic: true,
				strokeColor: '#FF0000',
				strokeOpacity: 1.0,
				strokeWeight: 2
			});

			routePath.setMap(map);
		}

		google.maps.event.addDomListener(window, 'load', initialize);

		var appendToTrack = function(response)
		{
			if (response == null)
				return;
			if (response.length < 3)
				return;
			if (routePath == null)
				return;

			var temp = JSON.parse(response);
			if (temp == null)
				return;

			var objList = JSON.parse(temp);
			if (objList == null)
				return;
			if (objList.length == 0)
				return;

			for (var i = 0; i < objList.length; ++i)
			{
				var path = routePath.getPath();
				routeCoordinates.push(new google.maps.LatLng(objList[i].latitude, objList[i].longitude));
				routePath.setPath(routeCoordinates);
				routePath.setMap(map);
			}

			lastLat = objList[objList.length - 1].latitude;
			lastLon = objList[objList.length - 1].longitude;
		};

		var updateMetadata = function(response)
		{
			if (response == null)
				return;
			if (response.length < 3)
				return;

			var temp = JSON.parse(response);
			if (temp == null)
				return;

			var objList = JSON.parse(temp);
			if (objList == null)
				return;

			contentString = '<div id="content">' +
				'<div id="siteNotice">' +
				'</div>' +
				'<h2 id="firstHeading" class="firstHeading">Last Known Position</h2>' +
				'<div id="bodyContent">' +
				'<p>'
			for (var i = 0; i < objList.length; ++i)
			{
				if (objList[i].name != "Name")
				{
					contentString += objList[i].name;
					contentString += " = ";
					contentString += objList[i].value;
					contentString += "<br>";
				}
			}
			contentString +=
				'</p>' +
				'</div>' +
				'</div>';
				
			if (infoWindow)
			{
				infoWindow.close();
				infoWindow = null;
			}
			if (marker)
			{
				marker.setMap(null);
				mark = null;
			}

			infoWindow = new google.maps.InfoWindow
			({
				content: contentString
			});

			marker = new google.maps.Marker
			({
				position: new google.maps.LatLng(lastLat, lastLon),
				map: map,
				title: 'Current Position'
			});

			google.maps.event.addListener(marker, 'click', function()
			{
				infoWindow.open(map,marker);
			});

			infoWindow.open(map,marker);
		};

		var checkForUpdates = function()
		{
			$.ajax({ type: 'POST', url: "${root_url}/updatetrack/${deviceStr}/${activityId}/${routeLen}", success: appendToTrack, dataType: "application/json" });
			$.ajax({ type: 'POST', url: "${root_url}/updatemetadata/${deviceStr}/${activityId}", success: updateMetadata, dataType: "application/json" });
		};

		$.ajax({ type: 'POST', url: "${root_url}/updatemetadata/${deviceStr}/${activityId}", success: updateMetadata, dataType: "application/json" });

		//setInterval(checkForUpdates, 15000);
	</script>

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>
	<div id="map-canvas"/>
</body>

</html>
